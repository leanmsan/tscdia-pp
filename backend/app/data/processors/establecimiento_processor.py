import re
import unicodedata
from typing import Optional
from .text_utils import quitar_tildes, limpiar_basico, normalizar_texto_base

# Mapeo de establecimiento notificador específico
MAPEO_ESTABLECIMIENTOS = {
    'MINISTERIO SALUD':'MINISTERIO DE SALUD',
    'CEAMM':'CEAMM', #Centro Especializado Analisis Moleculares Y Metabolicos
    'CENTRO DE CHAGAS': 'CENTRO DE CHAGAS Y PATOLOGIA REGIONAL',
    'DAHER-LABORATORIO': 'DAHER - LABORATORIO',
    'FLORES LUCENA LABORATORIO': 'FLORES LUCENA - LABORATORIO',
    'GIAMBRONI LABORATORIO': 'GIAMBRONI - LABORATORIO',

    #UPAS BANDA
    'EL CRUCE- UPA N?1': 'EL CRUCE - UPA N1',
    'EL CRUCE- UPA N§1': 'EL CRUCE - UPA N1',
    'CTRAL.ARGENTINO-UPA N?2': 'CENTRAL ARGENTINO - UPA N2',
    'CTRAL.ARGENTINO-UPA N§2': 'CENTRAL ARGENTINO - UPA N2',
    'CTRAL.ARGENTINO-UPA NRO2': 'CENTRAL ARGENTINO - UPA N2',
    'UPA N?2 CENTRAL ARGENTINO': 'CENTRAL ARGENTINO - UPA N2',
    'VILLA GRISELDA- UPA N?3': 'VILLA GRISELDA - UPA N3',
    'VILLA GRISELDA- UPA N§3': 'VILLA GRISELDA - UPA N3',
    'MISKI MAYU-UPA N?4': 'MISKY MAYU - UPA N4',
    'MISKI MAYU-UPA N§4': 'MISKY MAYU - UPA N4',
    'PARQUE INDRUSTRIAL- UPA No 5- BANDA': 'AMPLIACION PARQUE INDUSTRIAL - UPA N5',
    'PARQUE INDRUSTRIAL- UPA NØ 5- BANDA': 'AMPLIACION PARQUE INDUSTRIAL - UPA N5',
    'DORREGO- UPA N?6': 'DORREGO - UPA N6',
    'DORREGO- UPA NØ6': 'DORREGO - UPA N6',
    'DORREGO- UPA N 6':'DORREGO - UPA N6',
    'LOS LAGOS-UPA N?7': 'LOS LAGOS - UPA N7',
    'LOS LAGOS-UPA N§7': 'LOS LAGOS - UPA N7',
    'YANUZZI- UPAN?8': 'VILLA YANUCCI - UPA N8',
    'YANUZZI- UPANØ8': 'VILLA YANUCCI - UPA N8',

    #UPAS SANTIAGO
    'MARIANO M-UPA N?1': 'MARIANO MORENO I - UPA',
    'MARIANO M-UPA N§1': 'MARIANO MORENO I - UPA',
    'MARIANO MORENO 2-CENTRO DE SALUD (APS)': 'MARIANO MORENO II - UPA',
    'GENERAL PAZ- UPA N?1 CAPITAL': 'GENERAL PAZ - UPA N1',
    'GENERAL PAZ- UPA N§1 CAPITAL': 'GENERAL PAZ - UPA N1',
    'GENERAL PAZ- UPA N 1 CAPITAL': 'GENERAL PAZ - UPA N1',
    'CACERES- UPA N? 2': 'CACERES - UPA N2',
    'CACERES- UPA N§ 2': 'CACERES - UPA N2',
    'CACERES- UPA NRO 2': 'CACERES - UPA N2',
    'RECONQUISTA-UPA N?3': 'RECONQUISTA - UPA N3',
    'RECONQUISTA-UPA N§3': 'RECONQUISTA - UPA N3',
    'EJERCITO ARGENTINO-UPA N?4': 'EJERCITO ARGENTINO - UPA N4',
    'EJERCITO ARGENTINO-UPA N§4': 'EJERCITO ARGENTINO - UPA N4',
    'AUTONOMIA-UPA N§5': 'AUTONOMIA - UPA N5',
    'AUTONOMIA-UPA N?5': 'AUTONOMIA - UPA N5',
    'AUTONOMIA-UPA NRO5': 'AUTONOMIA - UPA N5',
    'SMATA-UPA N?6': 'SMATA - UPA N6',
    'SMATA-UPA N§6': 'SMATA - UPA N6',
    'PARQUE AGUIRRE-UPA N?7': 'PARQUE AGUILLE - UPA N7',
    'PARQUE AGUIRRE-UPA N§7': 'PARQUE AGUILLE - UPA N7',
    'LOS FLORES-UPA N§8': 'LOS FLORES - UPA N8',
    'LOS FLORES-UPA N?8': 'LOS FLORES - UPA N8',
    'UPA N?8-LOS FLORES': 'LOS FLORES - UPA N8',
    'JORGE NEWBERY- UPA N?9': 'JORGE NEWBERY - UPA N9',
    'JORGE NEWBERY- UPA N§9': 'JORGE NEWBERY - UPA N9',
    'KENNEDY- UPA N?10': 'JOHN KENNEDY - UPA N10',
    'KENNEDY- UPA N§10': 'JOHN KENNEDY - UPA N10',
    'SIGLO XX- UPA N§11': 'CAMPO CONTRERAS (O) - UPA N11',
    'SIGLO XX- UPA N?11': 'CAMPO CONTRERAS (O) - UPA N11',
    'C.CONTRERAS(O)-UPA N?11': 'CAMPO CONTRERAS (O) - UPA N11',
    'C.CONTRERAS(O)-UPA N§11': 'CAMPO CONTRERAS (O) - UPA N11',
    'MOSCONI-UPA N?13': 'MOSCONI - UPA N13',
    'MOSCONI-UPA N§13': 'MOSCONI - UPA N13',
    'MOSCONI-UPA NRO13': 'MOSCONI - UPA N13',
    'ALMIRANTE BROWN-UPA N?14': 'ALMIRANTE BROWN - UPA N14',
    'ALMIRANTE BROWN-UPA N§14': 'ALMIRANTE BROWN - UPA N14',
    'TRADICION OESTE - UPA No15': 'TRADICION OESTE - UPA N15',
    'TRADICION OESTE - UPA NØ15': 'TRADICION OESTE - UPA N15',
    'TRADICION OESTE - UPA NRO15': 'TRADICION OESTE - UPA N15',
    'TRADICION OESTE - UPA N?15': 'TRADICION OESTE - UPA N15',
    'CAMPO CONTREAS- UPA N?16': 'CAMPOS CONTRERAS - UPA N16',
    'CAMPO CONTREAS- UPA N§16': 'CAMPOS CONTRERAS - UPA N16',
    'BORGES- UPA N§17': 'BORGES - UPA N17',
    'BORGES- UPA N?17':'BORGES - UPA N17',
    'BARRIO INDEPENDENCIA-UPA N?19': 'INDEPENDENCIA - UPA N19',
    'UPA INDEPENDENCIA-UPA N§19': 'INDEPENDENCIA - UPA N19',
    'UPA INDEPENDENCIA-UPA N?19': 'INDEPENDENCIA - UPA N19',
    'BARRIO INDEPENDENCIA-UPA N§19': 'INDEPENDENCIA - UPA N19',
    'UPA N18-AEROPUERTO': 'AEROPUERTO - UPA N18',
    'UPA18 AEROPUERTO': 'AEROPUERTO - UPA N18',
    'VILLA ESTHER UPA N?20': 'VILLA ESTHER - UPA N20',
    'VILLA ESTHER UPA N§20': 'VILLA ESTHER - UPA N20',
    'CATOLICA-UPA N?21': 'LA CATOLICA - UPA N21',
    'CATOLICA-UPA N§21': 'LA CATOLICA - UPA N21',
    'CATOLICA-UPA NRO21': 'LA CATOLICA - UPA N21',
    'PERUCHILLO-UPA N?22': 'PERUCHILLO - UPA N22',
    'VINALAR-UPA N?23': 'VINALAR - UPA N23',
    'VINALAR-UPA N§23': 'VINALAR - UPA N23',
    'VINALAR-UPA NRO23': 'VINALAR - UPA N23',
    'SANTA LUCIA- UPA 24': 'SANTA LUCIA - UPA N24',
    'BELEN- UPA No25': 'BELEN - UPA N25',
    'BELEN- UPA NØ25': 'BELEN - UPA N25',
    'BELEN- UPA N?25': 'BELEN - UPA N25',

    #HOSPITALES
    'INDEPENDENCIA-HOSPITAL':'INDEPENDENCIA - HOSPITAL',
    'CEPSI EVA PERON': 'EVA PERON - HOSPITAL',
    'HOSPITAL REGIONAL': 'REGIONAL - HOSPITAL',
    'MAMA ANTULA CENTRO DE SALUD': 'MAMA ANTULA - CENTRO DE SALUD',
    'NEUMONOLOGICO DR. GUMERCINDO SAYAGO-HOSPITAL': 'DR GUMERSINDO SAYAGO - HOSPITAL',

    'AATUYA HOSPITAL ZONAL': 'AÑATUYA - HOSPITAL ZONAL',
    'A¤ATUYA HOSPITAL ZONAL': 'AÑATUYA - HOSPITAL ZONAL',
    'FERNANDEZ- HOSPITAL ZONAL' : 'FERNANDEZ - HOSPITAL ZONAL',
    'MONTE QUEMADO-HOSPITAL ZONAL': 'MONTE QUEMADO - HOSPITAL ZONAL',
    'PINTO-HOSPITAL ZONAL': 'PINTO - HOSPITAL ZONAL',
    'NUEVA ESPERANZA-HOSPITAL ZONAL': 'NUEVA ESPERANZA - HOSPITAL ZONAL',
    'LORETO- HOSPITAL ZONAL': 'LORETO - HOSPITAL ZONAL',
    'CAMPO GALLO-HOSPITAL ZONAL': 'CAMPO GALLO - HOSPITAL ZONAL',
    'OJO DE AGUA DR. CLEOFAS MAZZA-HOSPITAL ZONAL': 'OJO DE AGUA - HOSPITAL ZONAL',

    'SUNCHO CORRAL-HOSPITAL DISTRITAL': 'SUNCHO CORRAL - HOSPITAL DISTRITAL',
    'TINTINA-HOSPITAL DISTRITAL': 'TINTINA - HOSPITAL DISTRITAL',
    'SELVA-HOSPITAL': 'SELVA - HOSPITAL DISTRITAL',
    'BREA POZO-HOSPITAL DISTRITAL': 'BREA POZO - HOSPITAL DISTRITAL',
    'BANDERA- HOSPITAL DISTRITAL': 'BANDERA - HOSPITAL DISTRITAL',
    'SAN PEDRO DE GUASAYAN-HOSPITAL DE TRANSITO': 'SAN PEDRO DE GUASAYAN - HOSPITAL DISTRITAL',
    'CLODOMIRA DR GUILLERMO RAWSON- HOSPITAL DISTRITAL': 'CLODOMIRA - HOSPITAL DISTRITAL',
    'FORRES-HOSPITAL DISTRITAL': 'FORRES - HOSPITAL DISTRITAL',
    'PAMPA DE LOS GUANACOS-HOSPITAL DISTRITAL': 'PAMPA DE LOS GUANACOS - HOSPITAL DISTRITAL',
    'LOS JURIES-HOSPITAL DISTRITAL': 'LOS JURIES - HOSPITAL DISTRITAL',
    'DR ELISEO OGALLAR-HOSPITAL DISTRITAL': 'BANDERA - HOSPITAL DISTRITAL',
    'VILLA ATAMISQUI HOSPITAL DE TRANSITO': 'VILLA ATAMISQUI - HOSPITAL DISTRITAL',
    'POZO HONDO-HOSPITAL DISTRITAL': 'POZO HONDO - HOSPITAL DISTRITAL',

    'LAVALLE-HOSPITAL DE TRANSITO': 'LAVALLE - HOSPITAL DE TRANSITO',
    'LA CA¤ADA-HOSPITAL DE TRANSITO': 'LA CAÑADA - HOSPITAL DE TRANSITO',
    'COLONIA DORA-HOSPITAL DE TRANSITO': 'COLONIA DORA - HOSPITAL DE TRANSITO',
    'SUMAMPA DR. SCHULD GRAU-HOSPITAL DISTRITAL': 'SUMAMPA - HOSPITAL DE TRANSITO',
    'LOS TELARES-HOSPITAL DE TRANSITO': 'LOS TELARES - HOSPITAL DE TRANSITO',

    #CENTRO DE SALUD MUNICIPALES BANDA

    #CENTRO DE SALUD MUICIPALES SANTIAGO
    'CAPS N9 LOS FLORES': 'LOS FLORES - CAPS',
    'CAPS N?9 LOS FLORES': 'LOS FLORES - CAPS',
    'DR ARCHETTI - CAPS': 'DR ARMANDO ARCHETTI - CAPS',
    'ARMANDO ARCHETTI- CAPS': 'DR ARMANDO ARCHETTI - CAPS',
    'HIPOLITO IRIGOYEN (TRADICION) CAPS': 'HIPOLITO IRIGOYEN (TRADICION) - CAPS',
    'CAPS LOS LAGOS': 'LOS LAGOS - CAPS',
    'JUAN D SOLIS CAPS': 'NUESTRA SEÑORA DEL ROSARIO DE SAN NICOLAS - CAPS',
    'JUAN DIAZ SOLIS- CAPS': 'NUESTRA SEÑORA DEL ROSARIO DE SAN NICOLAS - CAPS',
    'CAPS FRANCISCO DE AGUIRRE': 'FRANCISCO DE AGUIRRE - CAPS',
    'DR ESTANISLAO PONCE-CAPS N?8 DE ABRIL': 'DR ESTANISLAO PONCE (8 DE ABRIL) - CAPS',
    'DR ESTANISLAO PONCE-CAPS NØ8 DE ABRIL': 'DR ESTANISLAO PONCE (8 DE ABRIL) - CAPS',
    'CIC CAMPO CONTRERAS': 'CAMPO CONTRERAS - CIC',
    'SANTISIMO SACRAMENTO B? BORGES- CAPS': 'SANTISIMO SACRAMENTO - CAPS',

    #CIS
    'BANDA-CIS': 'BANDA - CIS',
    'TERMAS DEL RIO HONDO-CIS': 'TERMAS DE RIO HONDO - CIS',

    # desconocidos
    'DESCONOCIDO': 'DESCONOCIDO',
    'NO INFORMADO': 'DESCONOCIDO',
    'SIN DATO': 'DESCONOCIDO',
    '-': 'DESCONOCIDO',
    'SIN DATOS': 'DESCONOCIDO',
    'DESCONOCIDA': 'DESCONOCIDO',
    'N/A': 'DESCONOCIDO',
    'NA': 'DESCONOCIDO',
    'NONE': 'DESCONOCIDO',
}

# Alias frecuentes en minúscula que podrían aparecer antes de limpiar
ALIAS_PREVIOS = {
    'desconocido': 'DESCONOCIDO',
    'na': 'DESCONOCIDO',
    'n/a': 'DESCONOCIDO',
    'none': 'DESCONOCIDO',
    'sin dato': 'DESCONOCIDO'
}

def limpiar_establecimiento(s: str) -> str:
    """Limpieza específica para establecimientos notificadores."""
    if s is None or (isinstance(s, float) and str(s).lower() == 'nan'):
        return None
    
    s = str(s).strip()
    
    # Arreglos típicos de mala codificación
    s = s.replace('?A', 'Á').replace('?E', 'É').replace('?I', 'Í').replace('?O', 'Ó').replace('?U', 'Ú')
    s = s.replace('A?', 'Á').replace('E?', 'É').replace('I?', 'Í').replace('O?', 'Ó').replace('U?', 'Ú')
    # Muy común: Ñ rota como "?"
    s = s.replace('N?', 'Ñ').replace('N§', 'Ñ')
    s = re.sub(r'\s+', ' ', s)  # espacios múltiples -> 1
    s = s.upper()
    
    return s

def normalizar_establecimiento_notificador(valor: str, quitar_tildes_flag: bool = True) -> str:
    """Pipeline de normalización para un valor de establecimiento notificador."""
    if valor is None or (isinstance(valor, float) and str(valor).lower() == 'nan') or str(valor).strip() == '':
        return 'DESCONOCIDO'

    # 1) limpieza básica específica para establecimientos
    v = limpiar_establecimiento(valor)
    
    # 2) alias previos (por si entró en minúscula exactamente)
    valor_original = str(valor).lower().strip()
    if valor_original in ALIAS_PREVIOS:
        v = ALIAS_PREVIOS[valor_original]

    # 3) quitar tildes (opcional). Ojo: mantiene Ñ.
    if quitar_tildes_flag:
        v = quitar_tildes(v)

    # 4) colapsar espacios otra vez por si quedó algo raro
    v = re.sub(r'\s+', ' ', v).strip()

    # 5) mapeo directo si existe
    if v in MAPEO_ESTABLECIMIENTOS:
        return MAPEO_ESTABLECIMIENTOS[v]
    
    return v.upper()
